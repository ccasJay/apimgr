# APIMgr Claude Code 配置同步增强 - 任务分解

## 项目概述

基于《APIMgr Claude Code 配置同步增强规范》（spec_claude_sync_enhancement_zh.md），本任务分解详细描述了实施精确更新机制的各个阶段和具体任务。

**核心目标**：修改 `apimgr` 工具的配置同步机制，从完全文件覆盖改为仅更新 Claude Code 配置文件中的 `env` 字段，保留所有注释、格式和非 ANTHROPIC 环境变量。

**技术方案**：
- 使用 `gjson/sjson` 库进行精确的 JSON 字段操作
- 实现原子文件更新保证数据安全
- 添加备份和验证机制
- 保持向后兼容性

## 总时间线

| 阶段 | 时间 | 主要目标 |
|------|------|----------|
| 第一阶段：准备 | 第1-2周 | 环境准备、依赖添加、功能标志 |
| 第二阶段：实施 | 第3-4周 | 核心逻辑实现、备份系统 |
| 第三阶段：测试 | 第5周 | 全面测试、性能基准 |
| 第四阶段：推出 | 第6周 | 金丝雀部署、监控、全面推出 |

**总估计开发时间**：12人日
**推荐时间表**：4周（含测试和推出）

## 任务分解

### T1: 环境准备和依赖添加
| 字段 | 内容 |
|------|------|
| **任务ID** | T1 |
| **任务名称** | 添加第三方依赖和功能标志 |
| **描述** | 添加 gjson/sjson 依赖，创建功能标志系统 |
| **优先级** | P0 |
| **估计时间** | 1天 |
| **依赖项** | 无 |
| **输出** | 更新的 go.mod，功能标志常量 |
| **状态** | 待开始 |

**详细步骤**：
1. 添加依赖到 `go.mod`：
   ```bash
   go get github.com/tidwall/gjson
   go get github.com/tidwall/sjson
   ```
2. 在 `config/config.go` 中添加功能标志常量：
   ```go
   const FeatureSurgicalUpdates = "surgical_updates_v1"
   ```
3. 验证依赖安装成功

---

### T2: 核心更新逻辑实现
| 字段 | 内容 |
|------|------|
| **任务ID** | T2 |
| **任务名称** | 实现 updateEnvField 函数 |
| **描述** | 使用 gjson/sjson 实现精确更新 env 字段的逻辑 |
| **优先级** | P0 |
| **估计时间** | 2天 |
| **依赖项** | T1 |
| **输出** | `updateEnvField()` 函数实现 |
| **状态** | 待开始 |

**详细步骤**：
1. 在 `config/config.go` 中创建 `updateEnvField` 函数：
   - 输入：原始 JSON 内容、APIConfig 配置、SyncOptions 选项
   - 输出：更新后的 JSON 内容或错误
2. 实现逻辑：
   - 使用 `gjson.Parse()` 解析但保留结构
   - 提取当前 `env` 字段（如果存在）
   - 创建更新的 env 映射，保留非 ANTHROPIC 字段
   - 设置新的 ANTHROPIC 值（仅非空值）
   - 使用 `sjson.SetRaw()` 应用更新
3. 添加辅助函数：`marshalWithComments()` 用于处理注释

---

### T3: 原子文件更新机制
| 字段 | 内容 |
|------|------|
| **任务ID** | T3 |
| **任务名称** | 实现 atomicFileUpdate 函数 |
| **描述** | 确保文件更新的原子性，防止数据损坏 |
| **优先级** | P0 |
| **估计时间** | 1.5天 |
| **依赖项** | T2 |
| **输出** | `atomicFileUpdate()` 函数实现 |
| **状态** | 待开始 |

**详细步骤**：
1. 在 `config/config.go` 中创建 `atomicFileUpdate` 函数：
   - 输入：文件路径、新内容、是否创建备份
   - 输出：错误（如果失败）
2. 实现原子更新模式：
   - 在同一目录创建临时文件
   - 将新内容写入临时文件
   - 如果请求，创建备份文件
   - 使用 `os.Rename()` 原子重命名
   - 失败时尝试从备份恢复
3. 添加辅助函数：`copyFile()`、`restoreFromBackup()`

---

### T4: 备份和恢复系统
| 字段 | 内容 |
|------|------|
| **任务ID** | T4 |
| **任务名称** | 实现备份管理系统 |
| **描述** | 自动管理备份文件，防止磁盘空间耗尽 |
| **优先级** | P1 |
| **估计时间** | 1.5天 |
| **依赖项** | T3 |
| **输出** | `BackupManager` 结构和方法 |
| **状态** | 待开始 |

**详细步骤**：
1. 创建 `BackupManager` 结构：
   ```go
   type BackupManager struct {
       backupPattern string
       maxBackups    int
   }
   ```
2. 实现方法：
   - `CreateBackup()`：创建时间戳命名的备份文件
   - `CleanupOldBackups()`：保留最近 N 个备份
   - `RestoreFromBackup()`：从指定备份恢复
3. 集成到 `atomicFileUpdate` 函数中

---

### T5: 验证和安全检查
| 字段 | 内容 |
|------|------|
| **任务ID** | T5 |
| **任务名称** | 实现更新验证机制 |
| **描述** | 确保更新只影响 env 字段，防止意外数据丢失 |
| **优先级** | P1 |
| **估计时间** | 2天 |
| **依赖项** | T2, T3 |
| **输出** | `validateJSONUpdate()` 函数实现 |
| **状态** | 待开始 |

**详细步骤**：
1. 实现 `validateJSONUpdate()` 函数：
   - 验证更新后的 JSON 结构有效
   - 确保只有 `env` 字段发生变化
   - 确保非 ANTHROPIC 字段未被修改或删除
2. 添加深度比较函数 `deepCompare()`
3. 添加环境变量提取函数 `extractEnv()`
4. 集成到更新流程中（更新前验证）

---

### T6: 集成到现有同步函数
| 字段 | 内容 |
|------|------|
| **任务ID** | T6 |
| **任务名称** | 修改 syncClaudeSettings 函数 |
| **描述** | 将新逻辑集成到现有的同步函数中 |
| **优先级** | P1 |
| **估计时间** | 1天 |
| **依赖项** | T2, T3, T5 |
| **输出** | 更新后的 `syncClaudeSettings()` 函数 |
| **状态** | 待开始 |

**详细步骤**：
1. 修改 `config/config.go` 中的 `syncClaudeSettings()` 函数：
   - 替换原有的完全覆盖逻辑
   - 使用新的 `updateEnvField()` 函数
   - 添加 `atomicFileUpdate()` 调用
   - 集成验证步骤
2. 确保向后兼容性：
   - 保持现有函数签名不变
   - 内部实现改为精确更新
3. 更新 `SyncClaudeSettingsOnly()` 函数（如果存在）

---

### T7: Dry-run 和诊断模式
| 字段 | 内容 |
|------|------|
| **任务ID** | T7 |
| **任务名称** | 实现诊断和测试功能 |
| **描述** | 添加 dry-run 模式，用于测试更新效果 |
| **优先级** | P2 |
| **估计时间** | 1天 |
| **依赖项** | T5, T6 |
| **输出** | `SyncOptions` 结构和 dry-run 功能 |
| **状态** | 待开始 |

**详细步骤**：
1. 创建 `SyncOptions` 结构：
   ```go
   type SyncOptions struct {
       DryRun        bool
       CreateBackup  bool
       PreserveOther bool
   }
   ```
2. 修改更新函数支持 options 参数
3. 实现 dry-run 模式：只验证不写入
4. 添加诊断输出：显示将进行的更改

---

### T8: 增强日志记录和指标
| 字段 | 内容 |
|------|------|
| **任务ID** | T8 |
| **任务名称** | 添加遥测和监控 |
| **描述** | 记录同步操作，收集性能指标 |
| **优先级** | P2 |
| **估计时间** | 1天 |
| **依赖项** | T6 |
| **输出** | `SyncMetrics` 结构和日志记录 |
| **状态** | 待开始 |

**详细步骤**：
1. 创建 `SyncMetrics` 结构：
   ```go
   type SyncMetrics struct {
       FullOverwrites   int64
       CommentLossCount int64
       FormatChanges    int64
       UpdateSuccess    int64
       UpdateFailures   int64
   }
   ```
2. 在更新函数中添加指标收集
3. 添加详细的日志记录：
   - 更新开始/结束时间
   - 更新的字段和值
   - 备份创建情况
   - 错误信息（如果发生）

---

### T9: 单元测试
| 字段 | 内容 |
|------|------|
| **任务ID** | T9 |
| **任务名称** | 编写单元测试 |
| **描述** | 为所有新函数编写全面的单元测试 |
| **优先级** | P1 |
| **估计时间** | 1.5天 |
| **依赖项** | T2, T3, T5 |
| **输出** | `*_test.go` 测试文件 |
| **状态** | 待开始 |

**详细步骤**：
1. 为 `updateEnvField()` 编写测试：
   - 测试所有边界情况
   - 测试注释保留
   - 测试错误处理
2. 为 `atomicFileUpdate()` 编写测试：
   - 测试正常更新
   - 测试备份创建
   - 测试恢复机制
3. 为 `validateJSONUpdate()` 编写测试
4. 使用表格驱动测试覆盖所有场景

---

### T10: 集成测试
| 字段 | 内容 |
|------|------|
| **任务ID** | T10 |
| **任务名称** | 编写集成测试 |
| **描述** | 测试整个同步流程，使用真实文件 |
| **优先级** | P1 |
| **估计时间** | 1天 |
| **依赖项** | T6, T9 |
| **输出** | 集成测试套件 |
| **状态** | 待开始 |

**详细步骤**：
1. 创建临时目录和测试文件
2. 测试完整同步流程：
   - 全局 Claude 配置更新
   - 项目级 Claude 配置更新
   - 错误场景处理
3. 验证文件权限保持不变（0600）
4. 验证备份文件正确创建和清理

---

### T11: 性能基准测试
| 字段 | 内容 |
|------|------|
| **任务ID** | T11 |
| **任务名称** | 性能测试和优化 |
| **描述** | 确保更新性能满足要求（<100ms） |
| **优先级** | P2 |
| **估计时间** | 0.5天 |
| **依赖项** | T6 |
| **输出** | 基准测试结果和优化建议 |
| **状态** | 待开始 |

**详细步骤**：
1. 编写基准测试：
   ```go
   func BenchmarkSurgicalUpdate(b *testing.B)
   func BenchmarkFullOverwrite(b *testing.B)
   ```
2. 测试不同文件大小：
   - 小文件（<10KB）
   - 中等文件（100KB）
   - 大文件（>1MB）
3. 分析性能瓶颈，进行优化

---

### T12: 向后兼容性验证
| 字段 | 内容 |
|------|------|
| **任务ID** | T12 |
| **任务名称** | 验证向后兼容性 |
| **描述** | 确保新版本与现有配置和工作流兼容 |
| **优先级** | P1 |
| **估计时间** | 0.5天 |
| **依赖项** | T6, T9, T10 |
| **输出** | 兼容性验证报告 |
| **状态** | 待开始 |

**详细步骤**：
1. 测试现有配置文件的读取和解析
2. 验证现有命令行为不变：
   - `apimgr switch`
   - `apimgr sync claude`
   - `apimgr sync status`
3. 确保环境变量导出格式不变

---

### T13: 金丝雀部署准备
| 字段 | 内容 |
|------|------|
| **任务ID** | T13 |
| **任务名称** | 准备逐步推出 |
| **描述** | 实现功能标志控制，准备监控 |
| **优先级** | P2 |
| **估计时间** | 0.5天 |
| **依赖项** | T8 |
| **输出** | 部署计划和监控配置 |
| **状态** | 待开始 |

**详细步骤**：
1. 完善功能标志系统：
   - 支持百分比 rollout
   - 支持特定用户启用
2. 设置监控告警：
   - 更新失败率 > 0.1%
   - 平均更新时间 > 100ms
3. 准备回滚计划

---

### T14: 文档更新
| 字段 | 内容 |
|------|------|
| **任务ID** | T14 |
| **任务名称** | 更新项目文档 |
| **描述** | 更新 README、使用说明和API文档 |
| **优先级** | P2 |
| **估计时间** | 0.5天 |
| **依赖项** | T6 |
| **输出** | 更新的文档文件 |
| **状态** | 待开始 |

**详细步骤**：
1. 更新 README.md：
   - 描述新的精确更新特性
   - 更新使用示例
2. 更新命令行帮助文档
3. 添加迁移指南（如果必要）

---

## 依赖关系图

```
T1 → T2 → T3 → T4
      ↓     ↓
      T5 → T6 → T7 → T8
            ↓    ↓
            T9 → T10 → T11 → T12
                        ↓
                        T13 → T14
```

**关键路径**：T1 → T2 → T3 → T6 → T9 → T10 → T11 → T12

## 风险管理

| 风险 | 概率 | 影响 | 缓解措施 | 相关任务 |
|------|------|------|----------|----------|
| JSON解析错误 | 中 | 高 | 预验证、备份恢复 | T5, T3 |
| 性能下降 | 低 | 中 | 基准测试、优化 | T11 |
| 第三方库问题 | 中 | 中 | 版本锁定、回退机制 | T1 |
| 跨平台兼容性 | 低 | 高 | 广泛平台测试 | T10 |
| 数据损坏 | 低 | 关键 | 原子更新、备份系统 | T3, T4 |

## 成功指标

### 量化指标
1. **注释保留率**：100%（自动验证）
2. **更新成功率**：>99.9%（监控系统）
3. **平均更新时间**：<100ms（性能测试）
4. **备份完整性率**：100%（哈希验证）

### 定性指标
1. **用户满意度**：格式和注释保留
2. **开发者信心**：更新安全性
3. **可维护性**：清晰的新代码结构
4. **文档完整性**：全面的功能文档

## 附录

### 相关文件
1. `spec_claude_sync_enhancement_zh.md` - 详细技术规范
2. `config/config.go` - 主要修改文件
3. `cmd/switch.go` - 触发同步的命令
4. `cmd/sync.go` - 同步相关命令

### 测试数据
见 spec 文件第7.2节中的测试用例，包含带注释的复杂 JSON 结构。

---

**最后更新**：2026-01-01
**版本**：1.0
**基于**：spec_claude_sync_enhancement_zh.md