# 交互式模型选择功能 - 开发任务清单

**基于规格文档**: spec.md (版本 1.0.0, 2026-01-01)
**创建日期**: 2026-01-01
**状态**: 规划中

## 项目背景

当前 `apimgr switch <alias>` 命令在切换支持多个模型的配置时，会默认使用配置中存储的 `model` 字段值（通常是第一个添加的模型）。这导致用户需要额外使用 `--model` 参数来选择不同模型，交互体验不流畅。

**解决方案**: 当切换支持多个模型的配置且用户未指定 `--model` 参数时，自动弹出交互式选择窗口，让用户选择要激活的模型。

## 设计原则

1. **渐进式交互**: 仅在必要时才询问用户（多个模型时）
2. **向后兼容**: 不影响现有脚本和自动化流程
3. **配置优先**: 尊重现有的配置默认值
4. **一致性**: 重用现有交互模式，保持用户体验统一

## 核心开发任务 (MVP)

### 任务1: 创建模型选择器基础结构
- **文件**: `cmd/model_selection.go`
- **描述**: 创建 `ModelSelector` 结构体及其核心方法
- **具体实现**:
  - `ShouldPrompt()`: 判断是否需要提示选择（检查模型数量、参数、交互环境）
  - `PromptSimple()`: 实现简单数字选择交互
  - `ValidateModelInList()`: 验证模型是否在支持列表中
- **验收标准**:
  - 代码编译通过
  - 基本方法签名与spec中的接口设计一致
  - 遵循现有代码风格（Go 1.24.0, Cobra框架）

### 任务2: 修改switch命令集成点
- **文件**: `cmd/switch.go`
- **描述**: 在现有切换逻辑中集成模型选择器
- **具体修改**:
  - 在 `RunE` 函数第56-76行之后添加交互逻辑
  - 处理 `--no-prompt` 参数
  - 调用 `ModelSelector.ShouldPrompt()` 判断是否显示选择
  - 如需要，调用 `ModelSelector.PromptSimple()` 获取用户选择
  - 更新配置的 `Model` 字段
  - 显示切换成功的反馈信息
- **验收标准**:
  - 现有功能不受影响（向后兼容）
  - 多模型配置时显示选择列表
  - 单模型配置不显示提示
  - 使用 `--no-prompt` 参数时禁用交互

### 任务3: 添加命令行参数支持
- **文件**: `cmd/switch.go` (命令定义部分)
- **描述**: 为switch命令添加新参数
- **具体实现**:
  - 添加 `--no-prompt` 参数: 禁用交互式模型选择
  - （可选）添加 `--list-models` 参数: 显示配置支持的模型列表并退出
- **验收标准**:
  - 参数正常工作
  - 参数帮助信息清晰
  - 不影响现有参数

### 任务4: 实现配置管理器扩展
- **文件**: `config/config.go`
- **描述**: 添加切换模型的方法
- **具体实现**:
  - 在 `Manager` 结构体中添加 `SwitchModel(alias, model)` 方法
  - 该方法更新指定配置的 `Model` 字段并保存到文件
  - 确保线程安全和文件锁正常工作
- **验收标准**:
  - 配置文件正确更新
  - 并发操作安全
  - 错误处理完善

## 关键测试任务

### 单元测试
- **文件**: `cmd/model_selection_test.go`
- **测试重点**:
  1. `TestShouldPrompt_单模型配置不提示`
  2. `TestShouldPrompt_多模型配置提示`
  3. `TestShouldPrompt_指定模型参数不提示`
  4. `TestShouldPrompt_非交互环境不提示`
  5. `TestShouldPrompt_显式禁用不提示`
  6. `TestPromptSimple_有效输入`
  7. `TestPromptSimple_无效输入处理`
  8. `TestPromptSimple_空输入使用默认值`

### 集成测试
- **文件**: `cmd/integration_test.go` (或现有测试文件)
- **测试场景**:
  1. 使用 `--model` 参数切换配置（旧用法兼容性）
  2. 非交互环境（管道输入）切换配置
  3. 多模型配置交互选择（模拟用户输入"2"）
  4. 单模型配置直接切换（无提示）
  5. 使用 `--no-prompt` 参数禁用交互

### 手动测试用例
1. **基础功能测试**:
   - 创建多模型配置: `apimgr add test --sk test-key --models "model1,model2,model3"`
   - 切换配置，验证选择列表显示
   - 选择不同模型，验证配置更新

2. **向后兼容性测试**:
   - 使用 `--model model2` 参数切换，验证直接使用指定模型
   - 在脚本中调用（非交互环境），验证无提示

3. **错误处理测试**:
   - 输入无效数字（如5），验证错误信息
   - 输入非数字，验证错误处理

## 实施优先级

### 第一阶段: 核心功能 (P0)
1. 任务1: 创建模型选择器基础结构
2. 任务2: 修改switch命令集成点
3. 任务4: 实现配置管理器扩展

### 第二阶段: 增强功能 (P1)
1. 任务3: 添加命令行参数支持（`--no-prompt`, `--list-models`）
2. 添加环境变量控制（`APIMGR_NO_PROMPT`, `APIMGR_ALWAYS_PROMPT`）

### 第三阶段: 生态集成 (P2)
1. 扩展到 `edit` 命令
2. 集成到项目级配置同步
3. （可选）TUI模式

## 验收标准汇总

1. **功能正确性**:
   - 多模型配置显示交互选择列表
   - 单模型配置直接切换无提示
   - 用户选择正确更新配置

2. **向后兼容性**:
   - 现有脚本和自动化流程不受影响
   - `--model` 参数功能不变
   - 非交互环境行为不变

3. **用户体验**:
   - 选择界面清晰易懂
   - 错误信息友好
   - 操作响应迅速（<100ms）

4. **代码质量**:
   - 无编译错误
   - 现有测试全部通过
   - 遵循项目代码规范
   - 无新增外部依赖

## 风险与缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 交互逻辑破坏脚本 | 低 | 高 | 自动检测非交互环境并禁用 |
| 终端兼容性问题 | 中 | 中 | 使用简单数字输入，无特殊字符 |
| 配置数据损坏 | 低 | 高 | 验证后写入，事务性操作 |
| 用户习惯抗拒 | 中 | 低 | 提供禁用选项（`--no-prompt`） |

## 下一步行动

1. **立即开始**: 任务1 - 创建 `cmd/model_selection.go`
2. **验证现有代码**: 确保理解 `cmd/switch.go` 当前逻辑
3. **增量开发**: 每完成一个任务，运行现有测试验证兼容性

---

**最后更新**: 2026-01-01
**相关文档**:
- [spec.md](./spec.md) - 功能规格说明
- [README.md](./README.md) - 项目概述
- [cmd/switch.go](./cmd/switch.go) - 现有切换命令实现

**注意事项**:
- 保持代码风格与现有项目一致
- 优先保证向后兼容性
- 关键测试通过前不提交代码